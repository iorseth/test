{% extends "base.html" %}

{% block content %}
  <div class="container-fluid">
    <h1 class="h3 mb-4 text-gray-800">Chart</h1>
    <form method="post">
      <div class="form-group">
        <label for="url">Select URL:</label>
        <select class="form-control" id="url" name="url" required onchange="handleUrlChange(this.value);">
          <option value="">-- Select a URL --</option>
          {% for url in config.urls %}
            <option value="{{ url }}" {% if url == selected_url %}selected{% endif %}>{{ url }}</option>
          {% endfor %}
        </select>
      </div>
    </form>
    {% if timestamps %}
      <canvas id="chart"></canvas>
      <script>
        function renderChart(timestamps, status_codes) {
          console.log('Rendering chart with data:', timestamps, status_codes);

          var ctx = document.getElementById('chart').getContext('2d');
          var chart = new Chart(ctx, {
            type: 'scatter',
            data: {
              datasets: [{
                label: 'Status Codes',
                data: timestamps.map(function (timestamp, i) {
                  return { x: new Date(timestamp), y: status_codes[i] };
                }),
                backgroundColor: 'rgba(75, 192, 192, 0.5)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
              }]
            },
            options: {
              scales: {
                x: {
                  type: 'time',
                  title: {
                    display: true,
                    text: 'Timestamp'
                  }
                },
                y: {
                  title: {
                    display: true,
                    text: 'Status Code'
                  },
                  beginAtZero: true
                }
              }
            }
          });
        }

        function handleUrlChange(selectedUrl) {
          $.post('{{ url_for('chart_page', _external=True) }}', { url: selectedUrl }, function(data) {
            console.log('Received data:', data);
            renderChart(data.timestamps, data.status_codes);
          });
        }

        window.onload = function() {
          window.initialTimestamps = JSON.parse('{{ timestamps|tojson }}');
          window.initialStatusCodes = JSON.parse('{{ status_codes|tojson }}');
          renderChart(window.initialTimestamps, window.initialStatusCodes);
        }
      </script>
    {% endif %}
  </div>
{% endblock %}


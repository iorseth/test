{% extends "base.html" %}

{% block content %}
  <div class="container-fluid">
    <h1 class="h3 mb-4 text-gray-800">Chart</h1>
    <form method="post">
      <div class="form-group">
        <label for="url">Select URL:</label>
        <select class="form-control" id="url" name="url" required>
          <option value="">-- Select a URL --</option>
          {% for url in config.urls %}
            <option value="{{ url }}" {% if url == selected_url %}selected{% endif %}>{{ url }}</option>
          {% endfor %}
        </select>
      </div>
    </form>
    <button type="button" class="btn btn-primary" id="testUpdateChartBtn">Test Update Chart</button>
    {% if timestamps %}
      <canvas id="chart"></canvas>
      <script>
        window.onload = function() {
          function renderChart(timestamps, status_codes) {
            console.log('Rendering chart with data:', timestamps, status_codes);

            var ctx = document.getElementById('chart').getContext('2d');
            var chart = new Chart(ctx, {
              type: 'scatter',
              data: {
                datasets: [{
                  label: 'Status Codes',
                  data: timestamps.map(function (timestamp, i) {
                    return { x: new Date(timestamp), y: status_codes[i] };
                  }),
                  backgroundColor: 'rgba(75, 192, 192, 0.5)',
                  borderColor: 'rgba(75, 192, 192, 1)',
                  borderWidth: 1
                }]
              },
              options: {
                scales: {
                  x: {
                    type: 'time',
                    title: {
                      display: true,
                      text: 'Timestamp'
                    }
                  },
                  y: {
                    title: {
                      display: true,
                      text: 'Status Code'
                    },
                    beginAtZero: true
                  }
                }
              }
            });
          }

          // Assign the updateChart function to the window object
          window.updateChart = function(selectedUrl) {
            $.ajax({
              url: '{{ url_for("chart_page", _external=True) }}',
              type: 'POST',
              data: { url: selectedUrl },
              dataType: 'json',
              success: function (data) {
                console.log('Update chart', data);
                renderChart(data.timestamps, data.status_codes);
              },
              error: function (error) {
                console.error('Error updating chart', error);
              }
            });
          };

          window.initialTimestamps = JSON.parse('{{ timestamps|tojson }}');
          window.initialStatusCodes = JSON.parse('{{ status_codes|tojson }}');
          renderChart(window.initialTimestamps, window.initialStatusCodes);

          // Attach the click event listener to the button
          document.getElementById('testUpdateChartBtn').addEventListener('click', function() {
            updateChart(document.getElementById('url').value);
          });

          // Attach the change event listener to the select element
          document.getElementById('url').addEventListener('change', function() {
            updateChart(this.value);
          });
        }
      </script>
    {% endif %}
  </div>
{% endblock %}

